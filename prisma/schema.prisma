generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
  moduleFormat    = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum AdminStatus {
  active
  inactive
}

enum PlatformAdminRole {
  super_admin
  user_manager
  analytics_viewer
  system_manager
  billing_manager
}

model PlatformAdmin {
  id                           String              @id @default(uuid())
  name                         String
  email                        String              @unique
  passwordHash                 String              @map("password_hash")
  roles                        PlatformAdminRole[]
  status                       AdminStatus         @default(active)
  mustResetPassword            Boolean             @default(true) @map("must_reset_password")
  passwordResetToken           String?             @map("password_reset_token")
  passwordResetTokenExpiresAt  DateTime?           @map("password_reset_token_expires_at")
  passwordChangedAt            DateTime?           @map("password_changed_at")
  lastLoginAt                  DateTime?           @map("last_login_at")
  createdAt                    DateTime            @default(now()) @map("created_at")
  updatedAt                    DateTime            @updatedAt @map("updated_at")

  @@map("platform_admins")
}

enum OtpType {
  password_reset
  email_verification
  two_factor_auth
}

enum UserType {
  platform_admin
  user
  manager
  tenant
}

model Otp {
  id        String   @id @default(uuid())
  otp       String
  type      OtpType
  userType  UserType @map("user_type")
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  isUsed    Boolean  @default(false) @map("is_used")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("otps")
  @@index([userId, type])
  @@index([otp, type])
}

enum UserStatus {
  active
  inactive
}

model User {
  id                           String      @id @default(uuid())
  name                         String
  email                        String      @unique
  passwordHash                 String      @map("password_hash")
  phone                        String?
  status                       UserStatus  @default(active)
  mustResetPassword            Boolean     @default(false) @map("must_reset_password")
  passwordChangedAt            DateTime?   @map("password_changed_at")
  lastLoginAt                  DateTime?   @map("last_login_at")
  createdAt                    DateTime    @default(now()) @map("created_at")
  updatedAt                    DateTime    @updatedAt @map("updated_at")

  @@map("users")
}

enum ManagerRole {
  tenant_manager
  payment_manager
  maintenance_manager
  operations_manager
  reports_viewer
}

model Manager {
  id                           String         @id @default(uuid())
  userId                       String         @map("user_id")
  name                         String
  email                        String         @unique
  passwordHash                 String         @map("password_hash")
  phone                        String?
  status                       UserStatus     @default(active)
  mustResetPassword            Boolean        @default(true) @map("must_reset_password")
  passwordChangedAt            DateTime?      @map("password_changed_at")
  lastLoginAt                  DateTime?      @map("last_login_at")
  createdAt                    DateTime       @default(now()) @map("created_at")
  updatedAt                    DateTime       @updatedAt @map("updated_at")

  buildingRoles                ManagerBuildingRole[]

  @@map("managers")
}

enum PlanStatus {
  active
  inactive
}

enum PlanType {
  public
  custom
}

model SubscriptionPlan {
  id            String      @id @default(uuid())
  name          String      @unique
  price         Decimal     @map("price")
  features      Json        // { maxBuildings: 1, maxUnits: 30, maxManagers: 5, premiumFeatures: ["hr_module"] }
  status        PlanStatus  @default(active)
  type          PlanType    @default(public)
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  subscriptions       Subscription[]
  historyAsOldPlan    SubscriptionHistory[] @relation("OldPlan")
  historyAsNewPlan    SubscriptionHistory[] @relation("NewPlan")

  @@map("subscription_plans")
}

model Building {
  id               String      @id @default(uuid())
  userId           String      @map("user_id")
  name             String
  address          String?
  city             String?
  country          String?
  contactEmail     String?     @map("contact_email")
  contactPhone     String?     @map("contact_phone")
  logoUrl          String?     @map("logo_url")
  settings         Json?
  status           UserStatus  @default(active)
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")
  
  tenants              Tenant[]
  leases               Lease[]
  maintenanceRequests  MaintenanceRequest[]
  payments             Payment[]
  invoices             Invoice[]
  announcements        Announcement[]
  utilityReadings      UtilityReading[]

  managerRoles     ManagerBuildingRole[]
  units            Unit[]

  @@map("buildings")
}

model ManagerBuildingRole {
  id          String         @id @default(uuid())
  managerId   String         @map("manager_id")
  buildingId  String         @map("building_id")
  roles       ManagerRole[]
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  manager     Manager        @relation(fields: [managerId], references: [id], onDelete: Cascade)
  building    Building       @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  @@unique([managerId, buildingId])
  @@index([managerId])
  @@index([buildingId])
  @@map("manager_building_roles")
}

enum UnitType {
  retail
  office
  storage
  restaurant
  guest_house
  other
}

enum UnitStatus {
  vacant
  occupied
  inactive
}

model Unit {
  id          String      @id @default(uuid())
  buildingId  String      @map("building_id")
  unitNumber  String      @map("unit_number")
  floor       Int?
  size        Decimal?
  type        UnitType?
  rentPrice   Decimal     @map("rent_price")
  status      UnitStatus  @default(vacant)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  leases               Lease[]
  maintenanceRequests  MaintenanceRequest[]
  payments             Payment[]
  invoices             Invoice[]

  building    Building    @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  @@unique([buildingId, unitNumber])
  @@index([buildingId])
  @@index([status])
  @@map("units")
}

enum TenantStatus {
  active
  inactive
}

model Tenant {
  id                           String        @id @default(uuid())
  buildingId                   String        @map("building_id")
  name                         String
  email                        String        @unique
  phone                        String?
  passwordHash                 String?       @map("password_hash")
  status                       TenantStatus  @default(inactive)
  mustResetPassword            Boolean       @default(false) @map("must_reset_password")
  passwordChangedAt            DateTime?     @map("password_changed_at")
  lastLoginAt                  DateTime?     @map("last_login_at")
  createdAt                    DateTime      @default(now()) @map("created_at")
  updatedAt                    DateTime      @updatedAt @map("updated_at")

  building                     Building      @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  leases                       Lease[]
  invoices                     Invoice[] 
  maintenanceRequests          MaintenanceRequest[]
  payments                     Payment[]

  @@index([buildingId])
  @@map("tenants")
}

enum LeaseStatus {
  active
  expired
  terminated
}

model Lease {
  id              String        @id @default(uuid())
  tenantId        String        @map("tenant_id")
  unitId          String        @map("unit_id")
  buildingId      String        @map("building_id")
  startDate       DateTime      @map("start_date")
  endDate         DateTime      @map("end_date")
  rentAmount      Decimal       @map("rent_amount")
  securityDeposit Decimal?      @map("security_deposit")
  status          LeaseStatus   @default(active)
  terms           Json?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  unit            Unit          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  building        Building      @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  paymentPeriods  PaymentPeriod[]

  @@index([tenantId])
  @@index([unitId])
  @@index([buildingId])
  @@index([status])
  @@map("leases")
}

enum MaintenanceRequestStatus {
  pending
  in_progress
  completed
  cancelled
}

enum MaintenanceRequestPriority {
  low
  medium
  high
  urgent
}

model MaintenanceRequest {
  id              String                      @id @default(uuid())
  buildingId      String                      @map("building_id")
  unitId          String?                     @map("unit_id")
  tenantId        String                      @map("tenant_id")
  title           String
  description     String
  priority        MaintenanceRequestPriority  @default(medium)
  status          MaintenanceRequestStatus    @default(pending)
  attachments     Json?
  notes           Json?  
  completedAt     DateTime?                   @map("completed_at")
  createdAt       DateTime                    @default(now()) @map("created_at")
  updatedAt       DateTime                    @updatedAt @map("updated_at")

  building        Building                    @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unit            Unit?                       @relation(fields: [unitId], references: [id], onDelete: SetNull)
  tenant          Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([buildingId])
  @@index([unitId])
  @@index([tenantId])
  @@index([status])
  @@map("maintenance_requests")
}

enum PaymentStatus {
  pending
  completed
  failed
  cancelled
}

enum PaymentType {
  rent
  utility
  deposit
  other
}

model Payment {
  id              String        @id @default(uuid())
  buildingId      String        @map("building_id")
  unitId          String?       @map("unit_id")
  tenantId        String        @map("tenant_id")
  invoiceId       String?       @map("invoice_id")
  amount          Decimal
  type            PaymentType
  status          PaymentStatus @default(pending)
  paymentDate     DateTime      @map("payment_date")
  notes           String?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  building        Building      @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unit            Unit?         @relation(fields: [unitId], references: [id], onDelete: SetNull)
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice         Invoice?      @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  paymentPeriods  PaymentPeriod[]

  @@index([buildingId])
  @@index([unitId])
  @@index([tenantId])
  @@index([invoiceId])
  @@index([status])
  @@map("payments")
}

enum InvoiceStatus {
  draft
  sent
  paid
  overdue
  cancelled
}

model Invoice {
  id              String        @id @default(uuid())
  buildingId      String        @map("building_id")
  unitId          String?       @map("unit_id")
  tenantId        String        @map("tenant_id")
  invoiceNumber   String        @unique @map("invoice_number")
  amount          Decimal
  dueDate         DateTime      @map("due_date")
  status          InvoiceStatus @default(draft)
  items           Json
  notes           String?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  building        Building      @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unit            Unit?         @relation(fields: [unitId], references: [id], onDelete: SetNull)
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payments        Payment[]

  @@index([buildingId])
  @@index([unitId])
  @@index([tenantId])
  @@index([status])
  @@map("invoices")
}

model Announcement {
  id              String        @id @default(uuid())
  buildingId      String        @map("building_id")
  title           String
  content         String
  priority        String?
  publishedAt     DateTime?     @map("published_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  building        Building      @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  @@index([buildingId])
  @@map("announcements")
}

enum UtilityType {
  electricity
  water
}

model UtilityReading {
  id              String        @id @default(uuid())
  buildingId      String        @map("building_id")
  type            UtilityType
  reading         Decimal
  readingDate     DateTime      @map("reading_date")
  notes           String?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  building        Building      @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  @@index([buildingId])
  @@index([type])
  @@map("utility_readings")
}

enum PaymentPeriodStatus {
  unpaid
  paid
  overdue
}

model PaymentPeriod {
  id           String   @id @default(uuid())
  leaseId      String
  month        String   // Format: YYYY-MM
  rentAmount   Decimal  @db.Decimal(10, 2)
  status       PaymentPeriodStatus @default(unpaid)
  paidAt       DateTime?
  paymentId    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  lease        Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  payment      Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  @@unique([leaseId, month])
  @@map("payment_periods")
}

enum ActivityAction {
  create
  update
  delete
  status_change
}

enum ActivityEntityType {
  unit
  tenant
  lease
  payment
  maintenance_request
  manager
  invoice
  subscription_plan
}

model ActivityLog {
  id          String              @id @default(uuid())
  action      ActivityAction
  entityType  ActivityEntityType  @map("entity_type")
  entityId    String              @map("entity_id")
  userId      String              @map("user_id")
  userName    String              @map("user_name")
  userRole    String              @map("user_role")
  buildingId  String              @map("building_id")
  details     Json?
  createdAt   DateTime            @default(now()) @map("created_at")

  @@index([buildingId])
  @@index([entityType])
  @@index([createdAt])
  @@map("activity_logs")
}

model PlatformActivityLog {
  id          String              @id @default(uuid())
  action      ActivityAction
  entityType  ActivityEntityType  @map("entity_type")
  entityId    String              @map("entity_id")
  adminId     String              @map("admin_id")
  adminName   String              @map("admin_name")
  details     Json?
  createdAt   DateTime            @default(now()) @map("created_at")

  @@index([createdAt])
  @@map("platform_activity_logs")
}

enum SubscriptionStatus {
  active
  cancelled
  expired
}

enum SubscriptionAction {
  created
  upgraded
  downgraded
  renewed
  cancelled
}

model Subscription {
  id                  String              @id @default(uuid())
  userId              String              @map("user_id")
  planId              String              @map("plan_id")
  totalAmount         Decimal             @map("total_amount")
  billingCycleStart   DateTime            @map("billing_cycle_start")
  billingCycleEnd     DateTime            @map("billing_cycle_end")
  nextBillingDate     DateTime            @map("next_billing_date")
  status              SubscriptionStatus  @default(active)
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  plan                SubscriptionPlan    @relation(fields: [planId], references: [id], onDelete: Restrict)
  history             SubscriptionHistory[]

  @@index([userId])
  @@index([planId])
  @@index([status])
  @@map("subscriptions")
}

model SubscriptionHistory {
  id                  String              @id @default(uuid())
  userId              String              @map("user_id")
  subscriptionId      String              @map("subscription_id")
  action              SubscriptionAction
  oldPlanId           String?             @map("old_plan_id")
  newPlanId           String              @map("new_plan_id")
  proratedAmount      Decimal?            @map("prorated_amount")
  notes               String?
  createdAt           DateTime            @default(now()) @map("created_at")

  subscription        Subscription        @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  oldPlan             SubscriptionPlan?   @relation("OldPlan", fields: [oldPlanId], references: [id], onDelete: SetNull)
  newPlan             SubscriptionPlan    @relation("NewPlan", fields: [newPlanId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([subscriptionId])
  @@map("subscription_history")
}

enum NotificationType {
  user_registration
  manager_created
  tenant_created
  payment_received
  invoice_created
  invoice_overdue
  maintenance_request_created
  maintenance_request_updated
  lease_created
  lease_expiring
  lease_expired
  subscription_created
  subscription_upgraded
  subscription_expiring
  subscription_expired
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  userType  UserType         @map("user_type")
  type      NotificationType
  title     String
  message   String           @db.Text
  isRead    Boolean          @default(false) @map("is_read")
  link      String?
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  @@index([userId, userType])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}